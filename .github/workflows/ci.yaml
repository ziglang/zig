name: ci
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  push:
    branches:
      - master
      - llvm19
concurrency:
  # Cancels pending runs when a PR gets updated.
  group: ${{ github.head_ref || github.run_id }}-${{ github.actor }}
  cancel-in-progress: true
permissions:
  # Sets permission policy for `GITHUB_TOKEN`
  contents: read
jobs:
  build-and-test:
    strategy:
      fail-fast: ${{ !contains(github.event.pull_request.labels.*.name, 'ci-build-all') }}
      matrix:
        include:
          - os: [self-hosted, Linux, x86_64]
            script: sh ci/x86_64-linux-debug.sh
            name: x86_64-linux-debug
            timeout: 420
          - os: [self-hosted, Linux, x86_64]
            script: sh ci/x86_64-linux-release.sh
            name: x86_64-linux-release
            timeout: 420
          - os: [self-hosted, Linux, aarch64]
            script: sh ci/aarch64-linux-debug.sh
            name: aarch64-linux-debug
            timeout: 480
          - os: [self-hosted, Linux, aarch64]
            script: sh ci/aarch64-linux-release.sh
            name: aarch64-linux-release
            timeout: 480
          - os: macos-13
            script: sh ci/x86_64-macos-release.sh
            name: x86_64-macos-release
            arch: x86_64
          - os: [self-hosted, macOS, aarch64]
            script: sh ci/aarch64-macos-debug.sh
            name: aarch64-macos-debug
            arch: aarch64
          - os: [self-hosted, macOS, aarch64]
            script: sh ci/aarch64-macos-release.sh
            name: aarch64-macos-release
            arch: aarch64
          - os: [self-hosted, Windows, x86_64]
            script: ci/x86_64-windows-debug.ps1
            name: x86_64-windows-debug
            arch: x86_64
            timeout: 420
          - os: [self-hosted, Windows, x86_64]
            script: ci/x86_64-windows-release.ps1
            name: x86_64-windows-release
            arch: x86_64
            timeout: 420
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.timeout || 480 }}
    env:
      ARCH: ${{ matrix.arch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build and Test
        run: ${{ matrix.script }}
